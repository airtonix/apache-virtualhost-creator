#!/usr/bin/env python
import sys
import subprocess
import re
import os
import pwd
import getpass
import shutil
import string
import array
import struct
import socket
import fcntl
import socket
import platform
from optparse import OptionParser


def message(message, level=None):
  START='\033['
  FINISH='\033[0m'

  BOLD='1;'

  BLACK="30"
  RED="31"
  GREEN="32"
  YELLOW="33"
  BLUE="34"
  MAGENTA="35"
  CYAN="36"
  GREY="37"

  BGBLACK="40"
  BGRED="41"
  BGGREEN="42"
  BGYELLOW="43"
  BGBLUE="44"
  BGMAGENTA="45"
  BGCYAN="46"
  BGGREY="47"

  if level == "header" :
    COLOURS="%s;%sm" % (GREY, BGBLUE)
  if level == "error" :
    COLOURS="%s;%sm" % (GREY, BGRED)
  elif level == "warning" :
    COLOURS="%s;%sm" % (BLACK,BGYELLOW)
  elif level == "debug" :
    COLOURS="%sm" % YELLOW
  elif level == "result" :
    COLOURS="%sm" % CYAN
  elif level == "success" :
    COLOURS="%sm" % GREEN
  elif level == "choice" :
    COLOURS="%sm" % BLUE
  else :
    COLOURS="%sm" % GREY

  return "%s%s %s %s" % (START, COLOURS, message, FINISH)


"""
    ------------
    --- TODO ---
    ------------
  COMPONENTS MANIFEST ACTIONS
  ---------------------------
    if if an action-section fails, then the component will not be processed.
  ComponentName
   | - >  1. action section name  : name of the action group
    2. actions    : actions to perform (actions with <> are references to functions here.
      | - > action command [parameter(s)] : action parameters (command is run for each parameter)
        (each action can also have a third conditional argument to determine if it should execute.
    3. condition    :  if this equals False, then this action group is skipped.

"""
PROCESS = {
 "create" : {

  "base" : [
    ["Export Variables",[
      ["<STORE>"                   , ["SITE_PATH_ROOT", "/var/www/${DOMAIN_FQDN}/"]],
    ]]
  ],


  "django" : [
    ["Install required dependancies",[
      ["<ENSURE_DEPENDANCIES>"              , ["python-setuptools", "libapache2-mod-wsgi"]],
    ], "self.variables['django']"],

    ["Create the Apache Python CGI", [
      ["<STORE>"                  , ["DJANGO_WSGI", """import os, sys\nsys.path.insert(0,'/var/www/${DOMAIN_FQDN}') \nos.environ['DJANGO_SETTINGS_MODULE'] = 'project.settings' \nimport django.core.handlers.wsgi \napplication = django.core.handlers.wsgi.WSGIHandler()"""]],
    ], "self.variables['django']"],

    ["Create the project base files", [
      ["<STORE>"                  , ["DJANGO_PROJECT_TEMPLATE_BASE", """
{% load site %}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
  <head>

    <title>{% block pageMeta_SiteName %} {% sitename %} {% endblock %} : {% block pageMeta_pageTitle %}Page Title{% endblock %}</title>

    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <meta name="author" content="{{ page_author }}" />
    <meta name="description" content="{{ page_description }}" />
    <meta name="keywords" content="{{ keywords }}" />
    <meta name="robots" content="index, follow, noarchive" />
    <meta name="googlebot" content="noarchive" />

    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}js/themes/base/ui.all.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/screen.css" media="screen" >
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/breadcrumbs.css" media="screen" >
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/browser.css" media="screen" >
    {% block stylesheets %} {% endblock %}
    {% block cssBlock %} {% endblock %}
    <!--[if IE 6]><link rel="stylesheet" type="text/css" href="/static/css/ie6.css" media="screen" /><![endif]-->

    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.3.2.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/ui/jquery-ui-1.7.2.custom.js"></script>
    {% block scripts %}{% endblock %}
    <script type="text/javascript">
    $(function(){
    })
    {% block jsBlock %} {% endblock %}
    </script>


  </head>
  <body class="page-{% block page_class %}base{% endblock %}">
    <div id="canvas">
      <div id="header" class="row">

        <div id="site-nav">
        {% block sitenav %}
          <ul class="admin">
            <li>
              <a href="/">dashboard</a>
            </li>
          </ul>
        {% endblock %}
        </div>

        <div id="site-name">
          {% block site_header %}
          <div class="site-title"> <h1><a href="{%block siteUrl %}siteUrl{%endblock%}">{%block site_title %} {% sitename %} {%endblock%}</a></h1> </div>
          <div class="site-subtitle"> <i>{% block site_subtitle %}{% endblock %}</i> </div>
          {% endblock %}
        </div>

      </div><!-- #header//-->

      <div id="page" class="row">
        <div id="breadcrumb">
        {% block breadcrumb %}
          <span class="crumb"><a href="{% url basic-browser-dashboard %}">root</a> </span>
        {% endblock %}
        </div>

      {% block body %}

        {% include search.html %}

        <div id="page-header" class="row">
          {% block page_header %}
            <div class="title"> <h1>{% block page_title %}{% endblock %}</h1> </div>
            <div class="subtitle"> <span>{% block page_subtitle %}{% endblock %}</span> </div>
          {% endblock %}
        </div><!-- #page-header//-->

        <div id="page-body" class="row">
        {% block main_content %}
        {% endblock %}
        </div><!-- #page-body//-->

      {% endblock %}
      </div><!-- #page//-->

      <div id="footer" class="row">
      {% block footer %}{% endblock %}
      </div><!-- #footer//-->

    </div>
  </body>
</html>
      """]],
      ["<STORE>"  , ["DJANGO_PROJECT_TEMPLATE_STYLES","""
html > body, body{
	font-family:sans-serif;
	font-size:62.5%;
	color:#333;
	background:#444;
	padding: 0;
	margin: 0;
}

a{
	color:#EE6002;
}
a:hover{
	color:#E1BB6B;
}

.row{
	float:left;
	display:inline;
	clear:both;
	width:100%;
}

#canvas{
	margin:0 auto;
	padding:0;
}


#header{
	display:inline;
	float:left;
	width:100%;

}
	#site-name{
	display:inline;
	float:left;
	width:20%;
	border-bottom-left-radius: 1em;
	-moz-border-radius-bottomleft: 1em;

	background: -moz-linear-gradient(top, #666 0%, #333 100%); /* firefox */
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#666), color-stop(100%,#333)); /* webkit */
	height:6em;
}
	#site-name a{

		text-decoration:none;
	}
	#site-name .site-title{
		display: inline;
		float: left;
		padding-top: 1em;
		width:100%;
		text-align:center;
	}
	#site-name .site-title h1{
		margin:0 0 0 0;
		padding:0;
	}
	#site-name .site-title a{
		letter-spacing:-1px;
	}
	#site-name .site-subtitle{
		width:100%;
		margin:0;
		text-align:center;

	}

	#site-nav{
		display:inline;
		float:left;
		width:80%;

	background: -moz-linear-gradient(top, #ccc 0%, #999 100%); /* firefox */
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ccc), color-stop(100%,#999)); /* webkit */
		border-bottom-right-radius: 1em;
		-moz-border-radius-bottomright: 1em;
		height:6em;
	}
	#site-nav ul{
		display:inline;
		float:left;
		margin:0 0 0 0;
		padding:0;
	}
	#site-nav li{
		display:inline;
		float:left;
		margin:0 0 0 0;
		padding:0;
	}
	#site-nav li a{
		display:inline;
		float:left;
		margin:0 0 0 0;
		text-decoration:none;
		padding: 2.5em 2em;
	}
	#site-nav li a:hover{
		background:#fff;
		color:#201B16;
	}


#page{
	background:#fff;
}
	#page-header{
		border-bottom:.5em solid #333;
	}
	#page-header .title{
		display: inline;
		float: left;
		padding:0;
		margin:0;
		padding:.5em 0 0 1em;
	}
	#page-header .title h1{
		padding:0;
		margin:0;
	}
	#page-header .subtitle{
		display: inline;
		float: left;
		padding:0;
		margin:0 0 0 1em;
		width:100%;
	}
      """]],
      ["<STORE>"  , ["DJANGO_PROJECT_TEMPLATE_TAG_SITES","""
from django import template
from django.template import Library, Node, resolve_variable
from django.conf import settings

register = template.Library()


class SiteNameNode(Node):
  def __init__(self, nodelist = None):
    self.nodelist = nodelist

  def render(self, context = None):
    return settings.PROJECT_NAME

@register.tag("sitename")
def sitename(parser=None, token=None):
  return SiteNameNode()

class SiteUrlNode(Node):
  def __init__(self, nodelist = None):
    self.nodelist = nodelist

  def render(self, context = None):
    return settings.PROJECT_URL

@register.tag("siteurl")
def siteurl(parser=None, token=None):
  return SiteUrlNode()
      """]],
      ["<STORE>"  , ["DJANGO_PROJECT_UTILS_AUTORENDER","""
from django.http import HttpResponse, HttpResponseRedirect
from django.shortcuts import render_to_response
from django.template import RequestContext

def auto_render(func):
    def _dec(request, *args, **kwargs):

        if kwargs.get('only_context', False):
            # return only context dictionary
            del(kwargs['only_context'])
            response = func(request, *args, **kwargs)
            if isinstance(response, HttpResponse) or isinstance(response, HttpResponseRedirect):
                raise Except("cannot return context dictionary because a HttpResponseRedirect as been found")
            (template_name, context) = response
            return context

        if kwargs.get('template_name', False):
            overriden_template_name = kwargs['template_name']
            del(kwargs['template_name'])
        else:
            overriden_template_name = None

        response = func(request, *args, **kwargs)

        if isinstance(response, HttpResponse) or isinstance(response, HttpResponseRedirect):
            return response
        (template_name, context) = response
        if overriden_template_name:
            template_name = overriden_template_name

        return render_to_response(template_name, context, context_instance=RequestContext(request))
    return _dec
      """]],
      ["<STORE>"  , ["DJANGO_PROJECT_MAINAPP_URLS","""
from django.conf.urls.defaults import *

urlpatterns = patterns('',
    url(r'^/$', 'dashboard', name='${DJANGO_MAIN_APPNAME_SLUG}-dashboard'),
)
      """]],
      ["<STORE>"  , ["DJANGO_PROJECT_MAINAPP_VIEWS","""
import os, datetime, time

from django.http import HttpResponse
from django.shortcuts import get_object_or_404, get_list_or_404

from project.utils.autorender import *
from utils import *
from forms import *

## LISTS
@auto_render
def dashboard(template_name="dashboard.html") :
  return template_name, { "data" : None }"""]],
    ], "self.variables['django']"],

    ["Create the apache Config Element",[
      ["<STORE>"  , ["DJANGO_CONFIG","""
 WSGIScriptAlias / ${SITE_PATH_ROOT}cgi-bin/django.wsgi
 Alias /robots.txt ${SITE_PATH_ROOT}public_html/robots.txt
 Alias /favicon.ico ${SITE_PATH_ROOT}public_html/favicon.ico
 Alias /static ${SITE_PATH_ROOT}public_html/static"""]],

      ["<STORE>"  , ["DJANGO_SETTINGS_PREFIX","""
import sys, os

sys.path.insert(0,
  os.path.abspath(
    os.path.normpath('%s/../' % os.path.dirname(__file__))
  )
)
PROJECT_NAME = "${DOMAIN_FQDN}"
PROJECT_ROOT = os.path.abspath( os.path.dirname(__file__) )
PROJECT_URL = "http://${DOMAIN_FQDN}"
SERVER_ROOT = os.path.abspath( os.path.normpath(os.path.dirname(PROJECT_ROOT) ) )
INTERNAL_IPS = ('127.0.0.1',)"""]],

      ["<STORE>"  , ["DJANGO_SETTINGS_SUFFIX","""
DATABASES['default']['ENGINE'] = 'django.db.backends.sqlite3'
DATABASES['default']['NAME'] = os.path.join(SERVER_ROOT, 'db', 'database.sqlite3')
TIME_ZONE='Australia/Adelaide'
LANGUAGE_CODE='en_AU'

MEDIA_ROOT = os.path.join(SERVER_ROOT,'public_html','files')
MEDIA_URL = '%s/files/' % PROJECT_URL

STATIC_ROOT = os.path.join(SERVER_ROOT,'public_html', 'static')
STATIC_URL = '%s/static/' % PROJECT_URL

ADMIN_MEDIA_PREFIX = '/static/admin/'

STATICFILES_DIRS = (
  os.path.join(SERVER_ROOT,'public_html'),
)

STATICFILES_FINDERS = (
  'django.contrib.staticfiles.finders.FileSystemFinder',
  'django.contrib.staticfiles.finders.AppDirectoriesFinder',
  'django.contrib.staticfiles.finders.DefaultStorageFinder',
)

TEMPLATE_LOADERS = (
  'django.template.loaders.filesystem.Loader',
  'django.template.loaders.app_directories.Loader',
  'django.template.loaders.eggs.Loader',
)
TEMPLATE_DIRS = (
  os.path.join(PROJECT_ROOT, "templates"),
  os.path.join(PROJECT_ROOT, "${DJANGO_MAIN_APPNAME}", "templates")
)

MIDDLEWARE_CLASSES = (
  'django.middleware.common.CommonMiddleware',
  'django.contrib.sessions.middleware.SessionMiddleware',
  'django.middleware.csrf.CsrfViewMiddleware',
  'django.contrib.auth.middleware.AuthenticationMiddleware',
  'django.contrib.messages.middleware.MessageMiddleware',
  'django.contrib.flatpages.middleware.FlatpageFallbackMiddleware',
)

INSTALLED_APPS = (
  'django.contrib.auth',
  'django.contrib.contenttypes',
  'django.contrib.sessions',
  'django.contrib.sites',
  'django.contrib.messages',
  'django.contrib.staticfiles',
  'django.contrib.admin',
  'django.contrib.admindocs',
  'django.contrib.flatpages',
  'django.contrib.markup',
  'south',
  '${DJANGO_MAIN_APPNAME}',
)"""]],

    ], "self.variables['django']"],

    ["Create the Django project : First Stage", [
      ["mkdir"                  , ["${SITE_PATH_ROOT}","-p"]],
      ["<DJANGOADMIN>"          , ["startproject", "project"], "${SITE_PATH_ROOT}"],
      ["<IMPROVE_DJANGO>"       , ["${SITE_PATH_ROOT}", "project", "settings.py"]],

      # TODO: initial Sync
      #["<DJANGOADMIN>"         , ["syncdb"], "${SITE_PATH_ROOT}"],
      # TODO : Link system admin media to this virtual host.
      #["<DJANGOADMIN>"         , ["collectstatic"], "${SITE_PATH_ROOT}"],
      # TODO :start initial migration.
      #["<DJANGOADMIN>"         , ["migrate"], "${SITE_PATH_ROOT}"]
    ], "self.variables['django']"],

    ["Create the Main Django Application", [
      ["touch"                  , ["${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/forms.py"]],
      ["<FILEWRITE>"            , ["${DJANGO_PROJECT_MAINAPP_URLS}", "${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/urls.py"]],
      ["<FILEWRITE>"            , ["${DJANGO_PROJECT_MAINAPP_VIEWS}", "${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/views.py"]],
    ], "self.variables['django'] and self.variables['DJANGO_MAIN_APPNAME']"],

    ["Create the Django Paths & Files", [
      ["mkdir"                  , ["${SITE_PATH_ROOT}db","-p"]],
      ["mkdir"                  , ["${SITE_PATH_ROOT}cgi-bin","-p"]],
      ["mkdir"                  , ["${SITE_PATH_ROOT}cgi-bin","-p"]],
      ["touch"                  , ["${SITE_PATH_ROOT}cgi-bin/django.wsgi"]],

      ["mkdir"                  , ["${SITE_PATH_ROOT}logs/django","-p"]],
      ["touch"                  , ["${SITE_PATH_ROOT}logs/django/errors.log"]],
      ["touch"                  , ["${SITE_PATH_ROOT}logs/django/debug.log"]],
      ["touch"                  , ["${SITE_PATH_ROOT}logs/django/access.log"]],

      ["mkdir"                  , ["${SITE_PATH_ROOT}public_html/static/js","-p"]],
      ["mkdir"                  , ["${SITE_PATH_ROOT}public_html/static/css","-p"]],
      ["mkdir"                  , ["${SITE_PATH_ROOT}public_html/static/img","-p"]],
      ["mkdir"                  , ["${SITE_PATH_ROOT}public_html/files","-p"]],

      ["mkdir"                  , ["${SITE_PATH_ROOT}project/utils","-p"]],
      ["touch"                  , ["${SITE_PATH_ROOT}project/utils/__init__.py"]],
      ["<FILEWRITE>"            , ["${DJANGO_PROJECT_UTILS_AUTORENDER}", "${SITE_PATH_ROOT}project/utils/autorender.py"]],

      ["mkdir"                  , ["${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/templatetags","-p"]],
      ["touch"                  , ["${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/templatetags/__init__.py"]],
      ["<FILEWRITE>"            , ["${DJANGO_PROJECT_TEMPLATE_TAG_SITES}", "${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/templatetags/site.py"]],

      ["mkdir"                  , ["${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/templates","-p"]],
      ["<FILEWRITE>"            , ["${DJANGO_PROJECT_TEMPLATE_BASE}", "${SITE_PATH_ROOT}project/${DJANGO_MAIN_APPNAME}/templates/base.html"]],

      ["<FILEWRITE>"            , ["${DJANGO_PROJECT_TEMPLATE_STYLES}", "${SITE_PATH_ROOT}public_html/static/css/screen.css"]],

      ["<FILEWRITE>"            , ["${DJANGO_WSGI}", "${SITE_PATH_ROOT}cgi-bin/django.wsgi"]],
    ], "self.variables['django']"],

    ["Create the Sqlite Database", [
      ["touch"                  , ["${SITE_PATH_ROOT}db/database.sqlite3"]],
      ["chmod"                  , ["777","${SITE_PATH_ROOT}db/database.sqlite3"]],
    ], "self.variables['django']"],


  ],


  "dns"  : [
    ["Avahi Daemon", [
      ["avahi-add-aliases"                , ["${SUBDOMAIN_NAME}.${HOSTNAME}.${DOMAIN}"]],
      ["avahi-publish-aliases"],
    ],"self.variables['isAvahi'] == True"],

    ["Bind9 Server", [
      ["<INSERTDNSRECORD>"                , ["${SUBDOMAIN_NAME}.${HOSTNAME}.${DOMAIN}", "${SERVERIP}"]],
    ],"self.variables['isAvahi'] == True"],
  ],


  "apache" : [
    ["Install required dependancies",[
      ["<ENSURE_DEPENDANCIES>"    , ["apache2"]],
    ]],

    ["Create Directories",[
      ["mkdir"                    , ["${SITE_PATH_ROOT}","-p"]],
      ["mkdir"                    , ["${SITE_PATH_ROOT}logs","-p"]],
      ["mkdir"                    , ["${SITE_PATH_ROOT}public_html","-p"]],
    ]],

    ["Create some convience files",[
      ["touch"                    , ["${SITE_PATH_ROOT}public_html/favicon.ico"]],
      ["touch"                    , ["${SITE_PATH_ROOT}public_html/favicon.png"]],
    ]],

    ["Setup Log Files", [
      ["touch"                    , ["${SITE_PATH_ROOT}logs/errors.log"]],
      ["touch"                    , ["${SITE_PATH_ROOT}logs/access.log"]],
    ]],

    ["Apache Default Authentication", [
      ["<STORE>"                  , ["APACHE_AUTHENTICATION_FRAGMENT","""
<Directory /var/www/${DOMAIN_FQDN}/public_html/>
 Options Indexes FollowSymLinks MultiViews
 AllowOverride All
 Order allow,deny
 allow from all
</Directory>"""]]
    ],"self.variables['isLdap']==False"],

    ["Apache-Ldap Directory Based Authentication", [
      ["<STORE>"                  , ["APACHE_AUTHENTICATION_FRAGMENT", """
<Directory /var/www/${DOMAIN_FQDN}/public_html/>
 Options Indexes FollowSymLinks MultiViews
 Order allow,deny
 allow from all
</Directory>
<Location / >
 AuthBasicProvider ldap
 AuthLDAPURL "ldap://localhost:389/${LDAP_BASE}?uid"
 AuthLDAPBindDN "cn=admin,dc=${HOSTNAME},dc=${DOMAIN}"
 AuthLDAPBindPassword "${LDAP_ADMIN_PASSWORD}"
 AuthType basic
 AuthName "Please provide valid crednetials for : ${DOMAIN_FQDN}"
 ${LDAP_REQUIRE_MODE}
 # TODO: Require ldap-attribute active=true
</Location>"""]]
    ],"self.variables['isLdap']==True"],

    ["Apache Vhost Definition File", [

      ["touch"                      , ["/etc/apache2/sites-available/${DOMAIN_FQDN}"]],
      ["<STORE>"                    , ["APACHE_VHOST_CONF", """
<VirtualHost *:80>
 ServerAdmin ${ADMIN_EMAIL}
 ServerName ${DOMAIN_FQDN}
 DocumentRoot /var/www/${DOMAIN_FQDN}/public_html

 ${APACHE_AUTHENTICATION_FRAGMENT}

 ${DJANGO_CONFIG}

 LogFormat "'time'='%t', 'user'='%u', 'client-ip'='%a', 'server-ip'='%A', 'server-name'='%v', 'url'='%U', 'status'='%>s'" authentications
 ErrorLog /var/www/${DOMAIN_FQDN}/logs/errors.log
 CustomLog /var/www/${DOMAIN_FQDN}/logs/access.log combined
 CustomLog /var/www/${DOMAIN_FQDN}/logs/authentications.log authentications
</VirtualHost>"""]],
      ["<FILEWRITE>"               , ["${APACHE_VHOST_CONF}", "/etc/apache2/sites-available/${DOMAIN_FQDN}"]],
      ["chown"                     , ["${ADMINUSER}:www-data", "${SITE_PATH_ROOT}", "-R"]],
      ["a2ensite"                  , ["${DOMAIN_FQDN}"]],
      ["service"                   , ["avahi-daemon"," stop"]],
      ["service"                   , ["avahi-daemon"," start"]],
      ["service"                   , ["apache2","restart"]],
    ]],
  ],

 },
 "remove" : {
  "base"  : [
  ],
  "django" : [
  ],
  "ldap"  : [
  ],
  "dns" : [
    ["Avahi CNAME Alias", [
      ["avahi-remove-aliases"       , ["${SUBDOMAIN_NAME}.${HOSTNAME}.${DOMAIN}"]],
    ],"self.variables['isAvahi'] == True"],
  ],
  "apache" : [
    ["Remove Apache Config", [
      ["a2dissite"                  , ["${DOMAIN_FQDN}" ]],
      ["rm"                         , ["/var/www/${DOMAIN_FQDN}", "-rf"]],
      ["rm"                         , ["/etc/apache2/sites-available/${DOMAIN_FQDN}"]],
    ]],
  ],
 }
}


class vhostCreator:
  """ Class doc """

  def __init__ (self, args):
    """ Class initialiser """
    self.required_components = ["base","apache"]
    self.debug = True
    self.testrun = args.isTestRun

    self.variables = {
      "MODE" : "create" if not args.remove else "remove",
    }

    self.variables["APPNAME"] = "Apache2 Virtual Host Creator"
    self.variables["APP_HEADER"] = self.process_template("${APPNAME}\ncreates apache virtual host subdomains for current machine.\nUbuntu 9.10, 10.04")
    self.variables["USERNAME"] = os.getenv("USER")
    self.variables["ADMINUSER"] = args.admin_user


    self.variables["isAvahi"] = args.isAvahi

    self.variables["HOSTNAME"] = args.hostname if args.hostname else self.popen_pipe("hostname").strip("\n")
    self.variables["DOMAIN"] = args.domain
    self.variables["SUBDOMAIN_NAME"] = args.subdomain
    self.variables["DOMAIN_FQDN"] = "%s.%s" % (self.variables["HOSTNAME"], args.domain)

    if args.subdomain :
      self.variables["DOMAIN_FQDN"] = "%s.%s" % (args.subdomain, self.variables["DOMAIN_FQDN"])

    self.variables["SERVERIP"] = args.server_ip if args.server_ip else "127.0.0.1"
    self.variables["BINDFILE"] = args.zone_file if args.zone_file else "/etc/bind/zones/home.db"

    self.variables["ADMIN_EMAIL"] = self.process_template(args.admin_email)
    self.variables["SITE_PATH_ROOT"] = None

    if args.isDjango :
      django = {}
      django["HANDLES_LDAP"] = args.djangoHandlesLDAP
      django["CONFIG"] = ""
      django["CGI"] = ""
      self.variables["DJANGO_MAIN_APPNAME"] = args.djangoMainAppName if args.djangoMainAppName else "site_portal"
      self.variables["DJANGO_MAIN_APPNAME_SLUG"] = string.replace(args.djangoMainAppName, "_", "-")

      self.variables["django"] = django


    self.variables["isLdap"] = args.isLdap
    self.variables["LDAP_URL"] = self.process_template(args.ldap_url)
    self.variables["LDAP_BASE"] = self.process_template(args.ldap_base)
    self.variables["LDAP_ADMIN"] = self.process_template(args.ldap_admin)
    self.variables["LDAP_ADMIN_PASSWORD"] = args.ldap_admin_password

    self.variables["LDAP_ALLOW_GROUPS"] = self.process_template(args.ldap_allow_groups)
    self.variables["LDAP_ALLOW_USERS"] = self.process_template(args.ldap_allow_users)

    if args.isLdap:
      self.required_components.insert(1,"ldap")

      if args.ldap_allow_groups :
        groups = []
        for group in self.process_template(args.ldap_allow_groups).split(";") :
          groups.append(" Require ldap-group %s" % group)
        self.variables["LDAP_REQUIRE_MODE"] = "\n ".join(groups)

      if args.ldap_allow_users :
        users = []
        for user in self.process_template(args.ldap_allow_users).split(";") :
          groups.append(" Require ldap-user %s" % user)
        self.variables["LDAP_REQUIRE_MODE"] = "\n ".join(users)

      if not args.ldap_allow_users and not args.ldap_allow_groups :
        self.variables["LDAP_REQUIRE_MODE"] = "Require valid-user"

    else:
      self.variables["LDAP_REQUIRE_MODE"]=""

    print ( message(self.variables["APP_HEADER"],"header") )

    if args.isDjango :
      self.required_components.insert(1,"django")

    if args.isAvahi :
      self.required_components.insert(1,"dns")

  def run (self):
    """ Function doc """
    process = PROCESS[self.variables["MODE"]]
    for component in self.required_components :
      self.logger( message("Processing Component : %s" % component, "header") )

      component = process[component]
      for step in component:

        label = step[0]
        actions = step[1]
        condition = True

        if len(step) > 2 :
          condition = eval(step[2])

        if not condition :
          continue
        else:
          self.logger( message("\t>>> %s " % label, "warning") )

        for command in actions :
          arg_elms = []

          try :
            for elm in command[1] :
              arg_elms.append( self.process_template( elm ) )
          except:
            pass

          if command[0] == "<STORE>" :
            self.logger( "Storing %s " % arg_elms[0] )
            self.variables[ arg_elms[0] ] = arg_elms[1]

          elif command[0] == "<FILEWRITE>" :
            self.dump_to_file(arg_elms[1], arg_elms[0])

          elif command[0] == "<ENSURE_DEPENDANCIES>" :
            required_dependancies = []
            for package in command[1] :
              # exec dpkg -S to obtain the package containing file
              proc = subprocess.Popen("dpkg -S " + package + " | awk -F':' '{ print $1 }'",
                shell = True,
                stdout = subprocess.PIPE,
                stderr = subprocess.PIPE
              )
              output = proc.communicate()

              # if no stderr
              if not output[1] :
                pkg = output[0].replace('\n','')
              else :
                required_dependancies.append(package)

            if len( required_dependancies ) > 0 :
              proc = subprocess.Popen( "apt-get install %s" % " ".join(required_dependancies) )

          elif command[0] == "<INSERTDNSRECORD>" :
            self.insert_bind_record(name = command[1][0], ip_address=command[1][1])

          elif command[0] == "<DJANGOADMIN>" :
            arg_elms.insert(0,"django-admin")
            arg_elms.insert(0, "sudo")
            self.logger( message("Attempting django-admin : %s " % " ".join( arg_elms ) ) )

            self.popen(arg_elms, self.process_template( command[2] ) )

          elif command[0] == "<IMPROVE_DJANGO>" :
            path = os.path.join( *self.process_template( command[1] ) )
            self.logger( message("waiting for django settings file to exist.", "warning") )
            if not self.testrun :
              while not ( os.path.exists(path) ) :
                pass
              self.improve_django_settings( path )

          else :
            self.execute("%s %s" % (command[0]," ".join(arg_elms) ) )

  def logger (self,*msg):
    """ Function doc """
    if self.debug :

      print( "%s%s" % (message("[ %s ]" % self.variables["APPNAME"])," ".join(msg) ) )

  def process_template(self, source) :
    """ Function doc """

    if isinstance(source, str) :
      output = self._process_template(source)

    else :
      output = []
      for item in source :
        output.append( self._process_template( item ) )

    return output

  def _process_template(self, source) :
    if re.search('\$\{([a-zA-Z0-9_]+)\}', source)!=None :
      return string.Template( source ).safe_substitute(self.variables)
    else :
      return source

  def ensure_dir(self, path) :
    """
      Looks for a folder at provided path, creates it if it does not exist.
      Returns the folder.
    """
    folder = os.path.exists(path)
    if not folder:
      if not self.testrun :
        folder = os.makedirs(path)
      self.logger("ensuring folder : %s " % path)
    self.logger( message("folder ensured : %s " % path, "success") )
    return folder

  def ensure_file (self, path):
    """
      Looks for  file at provided path, creates it if it does not exist.
      Returns the file.
    """
    file = os.path.exists(path) and os.path.isfile(path)
    if not file :
      # test for parent folder
      if not os.path.exists(os.path.split(path)[0]) :
        self.ensure_dir(os.path.split(path)[0])
      if not self.testrun :
        file = open(path,"w");
      self.logger("ensuring file : %s " % path)

    self.logger( message("file ensured : %s " % path,"success") )
    return file

  def get_ip_address(self,ifname):
    SIOCGIFADDR = 0x8915
    SIOCGIFCONF = 0x8912  #define SIOCGIFCONF
    MAXBYTES = 8096
    BYTES = 4096          # Simply define the byte size

    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try :
      ip = socket.inet_ntoa(fcntl.ioctl(
        s.fileno(),
        SIOCGIFADDR,  #
        struct.pack('256s', ifname[:15])
      )[20:24])
    except :
      print("Can't sniff %s" % ifname)
      ip = None
    return ip

  def popen_pipe(self, cmd) :
    self.logger("PopenPipe: %s" % cmd)
    result = ""
    if not self.testrun :
      result = subprocess.Popen(cmd, stdout=subprocess.PIPE).communicate()[0]
    return result

  def popen(self, cmd, current_working_directory=None) :
    self.logger("Popen : %s" % cmd)
    if not self.testrun :
      subprocess.Popen(cmd,cwd=current_working_directory)

  def execute(self, args):
    self.logger("Executing : %s" % args)
    if not self.testrun :
      os.system(args)

  def dump_to_file (self,filepath, contents):
    """ Function doc """
    self.logger("Dumping contents to file : %s" % filepath)
    self.ensure_file(filepath)
    if not self.testrun :
      _file = open(filepath,"w")
      _file.write(contents)
      _file.close()

  def insert_bind_record(self, name, ip_address):
    # open zone file
    bind_file = open(self.variables["BINDFILE"], "a")
    record = '{0} {1:>10} {2:>15}'.format(name, "A", ip_address)
    bind_file.write( record )
    bind_file.close()
    
  def improve_django_settings(self, path):
    settings_file = ""
    try :
      self.logger( message("Improving Django Settings File \n\t > %s" % path) )

      self.logger( message(" + reading....") )
      if not self.testrun :
        try :
          file = open(path, "r")
          settings_file = file.readlines()

          self.logger( message(" + making a backup") )
          try :
            backup = open("%s.original" % path, "w")
            backup.writelines( settings_file )
            backup.close()
          except IOError as (errno, strerror):
            self.logger( message( "I/O error({0}): {1}".format(errno, strerror) , "error") )
            raise IOError
          except ValueError:
            self.logger( message( "Could not convert data." , "error") )
            raise ValueError

          file.close()
        except IOError as (errno, strerror):
          self.logger( message( "I/O error({0}): {1}".format(errno, strerror) , "error") )
          raise IOError
        except ValueError:
          self.logger( message( "Could not convert data." , "error") )
          raise ValueError


      improvements =[
        self.process_template( self.variables["DJANGO_SETTINGS_PREFIX"] ),
        "".join(settings_file),
        self.variables["DJANGO_SETTINGS_SUFFIX"],
      ]

      self.logger( message(" + writing improvements" ) )


      if not self.testrun :
        try :
          output_file = open(path, "w")
          output_file.write( str("\n".join( improvements ) ) )
          output_file.close()

        except IOError as (errno, strerror):
          self.logger( message( "I/O error({0}): {1}".format(errno, strerror) , "error") )
          raise IOError
        except ValueError:
          self.logger( message( "Could not convert data." , "error") )
          raise ValueError

      self.logger( message( "Finished improving the Django Settings File" , "success") )

    except:
      self.logger( message( "Improvements failed." , "error") )



if __name__ == "__main__" :

    parser = OptionParser()


    parser.add_option("--remove",
      dest="remove",
      action="store_true",
      default=False,
      help="remove this virtualhost")

    parser.add_option("--test",
      dest="isTestRun",
      action="store_true",
      default=False,
      help="Dry Test Run.")


    parser.add_option("--subdomain",
      dest="subdomain",
      action="store",
      help="name of the vhost subdomain")
    parser.add_option("--hostname",
      dest="hostname",
      action="store",
      help="name of the vhost subdomain")
    parser.add_option("--domain",
      dest="domain",
      action="store",
      help="name of the vhost subdomain")

    parser.add_option("--server-ip",
      dest="server_ip",
      action="store",
      help="ip address of the apache server")
    parser.add_option("--zone-file",
      dest="zone_file",
      action="store",
      default="/etc/bind/zones/home.db",
      help="bind zone file")

    parser.add_option("--email",
      dest="admin_email",
      action="store",
      default="${USERNAME}@localhost",
      help="email address of the site admin")
    parser.add_option("--admin-user",
      dest="admin_user",
      action="store",
      default="www-data",
      help="username to chown the site-root with")

    parser.add_option("--no-avahi",
      dest="isAvahi",
      action="store_false",
      default=True,
      help="virtualhost will create avahi aliases, otherwise you create your own dns entries")

    parser.add_option("--ldap",
      dest="isLdap",
      action="store_true",
      default=False,
      help="Virtualhost will be a use and ldap server for authentication")
    parser.add_option("--ldap-url",
      dest="ldap_url",
      action="store",
      default="ldap://ldap.${HOSTNAME}.${AVAHI_DOMAIN}:389",
      help="URI of the ldap authentication server")
    parser.add_option("--ldap-admin",
      dest="ldap_admin",
      action="store",
      default="cn=admin,dc=${HOSTNAME},dc=${AVAHI_DOMAIN}",
      help="URI of the ldap authentication server")
    parser.add_option("--ldap-admin-password",
      dest="ldap_admin_password",
      action="store",
      default="password",
      help="URI of the ldap authentication server")
    parser.add_option("--ldap-base",
      dest="ldap_base",
      action="store",
      default="dc=${HOSTNAME},dc=${AVAHI_DOMAIN}",
      help="Distinguished Name (DN) of the search base to look for Organisational Units, remember that if we are requiring a group that this DN must be above both the user tree and the group tree.")
    parser.add_option("--ldap-allow-groups",
      dest="ldap_allow_groups",
      action="store",
      default="",
      help="semicolon separated Distinguished Name (DN) of the groups allowed to access this resource"),
    parser.add_option("--ldap-allow-users",
      dest="ldap_allow_users",
      action="store",
      default="",
      help="semicolon separated UIDs of users allowed to access this resource")

    parser.add_option("--django",
      dest="isDjango",
      action="store_true",
      default=False,
      help="virtualhost will be a django application")
    parser.add_option("--django-ldap",
      dest="djangoHandlesLDAP",
      action="store_true",
      default=False,
      help="Ldap Authentication will be handled by the django backend instead of apache.")
    parser.add_option("--django-main-app",
      dest="djangoMainAppName",
      action="store",
      default="site_portal",
      help="Allows you to define the name of the main (or first) Django Application.")


    (options,args) = parser.parse_args()

    arg_error = False


    if not options.remove and options.admin_email == None :
      print("Need an email address")
      arg_error = True

    if arg_error == True :
      parser.print_help()
      exit(-1)
    else :
      vhost = vhostCreator(options)
      vhost.run()

